const fs = require("fs");
const hre = require("hardhat");
const inquirer = require("inquirer");
const { BigNumber } = require("ethers");

const formatContract = (contractName, contractAddress) => `
import ${contractName} from "./hardhat/${contractName}.json";
// To update hardhat contract details run: npm run update-contracts
// To deploy contracts on a local hardhat network and update details run: npm run setup-localhost

export let ${contractName}Contract = {
  addressOrName: "${contractAddress}",
  contractInterface: ${contractName}.abi,
};
`;

function copyFile(source, target, cb) {
  var cbCalled = false;

  var rd = fs.createReadStream(source);
  rd.on("error", function (err) {
    done(err);
  });
  var wr = fs.createWriteStream(target);
  wr.on("error", function (err) {
    done(err);
  });
  wr.on("close", function (ex) {
    done();
  });
  rd.pipe(wr);

  function done(err) {
    if (!cbCalled) {
      cb(err);
      cbCalled = true;
    }
  }
}

const formatQuestions = (constructorInputs) => {
  let questions = constructorInputs.map((input) => {
    return {
      type: input.type,
      name: input.name,
      message: `Enter ${input.name}:`,
      askAnswered: true,
    };
  });
  return questions;
};

const FRONTEND_DIR = "../website/src/contracts";

const readConstructorParams = (constructorParams) =>
  new Promise(async (resolve, reject) => {
    try {
      let answers = [];
      let questions = formatQuestions(constructorParams);

      for (const question of questions) {
        answers.push(await inquirer.prompt([question]));
      }

      let formatedAnswers = answers.map((value, i) => {
        if (questions[i].type == "uint256") {
          let bigNumberValue = BigNumber.from(Object.values(value)[0]);
          console.log("BigNumber", bigNumberValue);
          return bigNumberValue;
        } else {
          return Object.values(value)[0];
        }
      });

      resolve(formatedAnswers);
    } catch (e) {
      reject(e);
    }
  });

const main = async () => {
  const contracts = fs.readdirSync("./artifacts/contracts");
  let i = 0;

  let indexImports = [];
  let indexExports = [];
  for (const contract of contracts) {
    // Copy the contract details generated by hardhat to the frontend/contracts/hardhat folder
    let contractName = contract.slice(0, contract.length - 4);
    let contractFactory = await ethers.getContractFactory(contractName);
    let constructorParams = contractFactory.interface.fragments.find(
      (x) => x.type == "constructor"
    ).inputs;
    let source = `./artifacts/contracts/${contract}/${contractName}.json`;
    let target = `${FRONTEND_DIR}/hardhat/${contractName}.json`;
    let constructorInputs = await readConstructorParams(constructorParams);

    await copyFile(source, target, (e) => {
      i++;
      let messageSuccess =
        "Successfully copied contract " +
        contractName +
        " " +
        i +
        "/" +
        contracts.length;
      let messageError = "Error copying contract" + contractName + e;
      let message = e == undefined ? messageSuccess : messageError;
      console.log(message);
    });

    let contractDeployment = await contractFactory.deploy(...constructorInputs);
    console.log(contractDeployment.address);

    const contractConfigFileData = formatContract(
      contractName,
      contractDeployment.address
    );
    fs.writeFileSync(
      `${FRONTEND_DIR}/${contractName}.js`,
      contractConfigFileData
    );

    indexImports.push(
      `import {${contractName}Contract} from "./${contractName}.js";`
    );
    indexExports.push(`${contractName}Contract`);
  }
  let indexFileData = `${indexImports.join(
    "\n"
  )}\n\nexport {${indexExports.join(", ")}}`;

  fs.writeFileSync(`${FRONTEND_DIR}/index.js`, indexFileData);
};

main().catch(console.error);
